#### 本章导图

> 对照ArcGIS Pro “Spaital analyst” 箱（图）
> 

> a.参照课程实验，实验区等高线图层、slope/aspect等计算，水源涵养重要性评估
> b.初步按以下9个小节编写，实验时再看有些功能是否可删除中整合
> c.这一章主要是对DEM，以及降水等空间插值得到的连续场栅格数据的分析

栅格数据结构简单、直观，利于计算机操作和处理，是GIS常用的空间基础数据格式。基于栅格数据的空间分析是GIS空间分析的基础，也是ArcGIS的空间分析模块的核心内容。栅格数据的空间分析主要包括：距离分析、空间插值、表面生成与分析、统计分析（单元统计、领域统计、分类区统计等）、重分类、栅格计算等功能。

ArcGIS pro的栅格数据空间分析模块主要由“Spatial Analyst”提供有效工具集，方便执行各种栅格数据空间分析操作，解决空间问题。 本章将对ArcGIS pro中栅格数据空间分析的各模块从原理上和实现上作详细的说明，并附以具体实例，引导读者更好地应用。

#### 7.1 距离分析

基于距离的空间分配方法常采用矢量数据的形式进行计算，而栅格数据具有其独特性，也可基于栅格像元计算面向像元的距离分配范围。基于栅格数据的距离分析得到的栅格分配算法，直接将栅格数据作为模型基础，基于像元间距进行最近距离的计算与分配。

距离分析根据每一栅格相距其最邻近要素（也称为“源”）的距离来进行分析，从而反映出每一栅格与其最邻近源的相互关系。通过距离分析可以获得很多相关信息，指导人们进行资源的合理规划和利用。例如，飞机失事紧急救援时从指定地区 到最近医院的距离；消防、照明等市政设施的布设及其服务区域的分析等。此外，也可以根据某些成本因素找到A地到B地的最短路径或成本最低路径。

ArcGIS pro中，距离分析的工具集用于执行考虑直线（欧氏）或加权距离的分析。距离可以通过简单的成本（摩擦）表面或以考虑对移动的垂直和水平限制的方式进行加权。

| 工具           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 廊道分析       | 计算两个输入累积成本栅格的累积成本总和。                     |
| 距离累积       | 计算每个像元到源的累积距离，允许直线距离、成本距离、真实表面距离以及垂直和水平成本系数。 |
| 距离分配       | 根据直线距离、成本距离、真实表面距离以及垂直和水平成本系数，计算每个单元到所提供的源的距离分配。 |
| 最佳路径为线   | 将从源到目的地的最佳路径计算为线。                           |
| 最佳路径为栅格 | 将从源到目的地的最佳路径计算为栅格。                         |
| 最佳区域连接   | 在两个或多个输入区域之间计算最佳连通性网络。                 |

##### 操作示例

ArcGIS Pro中“距离分析”提供的工具可以帮助我们研究如何在环境成本因子（如林地、水域等）的影响下选定一条花费成本最低的道路。以建德东部七镇为研究区域，将从A点到B点修建一条从学校通往某目的地的道路，本例将示范如何选定该道路。

1.得到成本栅格和表面栅格：将各成本因子加权叠加，并转换为覆盖研究区域的栅格数据。本例中，依据不同环境因子下铁路建造的成本花费值不同，将林地的成本值设置为5、水域的成本值设置为10、其余区域成本值默认为1，得到成本栅格“cost.tif”。建德东部七镇的数字高程模型像元大小为30m*30m，得到表面栅格”七镇DEM30.tif“。

![image-20210216125915468](image\image-1-1.png)

2.得到累积成本距离：“A.shp”为A地，代表道路建设的起点；使用“距离累积”工具计算以A地位源的累积距离栅格。

（1）在“Spatial Analyst工具”下拉菜单中选择“距离”，在弹出的下一级菜单中点击“累积距离” ，出现“累积距离”对话框；

（2）在“输入栅格或要素源数据”栏的下拉菜单中选择需要分配单元的源图层，选择“A.shp”；

（3）在“输入表面栅格”栏选择“七镇DEM30.tif”，高程值用于计算经过两个像元的实际表面距离；在“输入成本栅格”栏选择“cost.tif”，其像元值表示经过该像元时移动单位距离所需的成本；

（4）为输出结果指定目录及名称，将输出的距离累积栅格命名为“distance.tif”，将输出的反向栅格命名为“backward.tif”；

（5）其余参数保留默认值，点击“运行”后得到输出（见图）。

![image-20210216134646131](image\image-1-2.png)



3.得到最佳路径：“B.shp”为B地，代表道路建设的终点；使用“最佳路径为线”工具计算从源到目标累积成本最低的路径。

（1）在“Spatial Analyst工具”下拉菜单中选择“距离”，在弹出的下一级菜单中点击“最佳路径为线”，出现工具对话框；

（2）在“输入栅格或要素目标数据”栏的下拉菜单中选择“B.shp”，标识路径的目标终点位置；

（3）在“输入距离累积栅格”栏选择“distance.tif”，在“输入反向或流向栅格”栏选择“backward.tif”；

（4）为输出结果指定目录及名称，将输出的最佳路径命名为“optimal_path.shp“；

（5）其余参数保留默认值，点击“运行”后得到输出（见图）即为A地到B地的最佳路径。

![image-20210216140709537](image\image-1-3.png)

#### 7.2 空间插值

空间插值主要根据输入的已知点要素的数值及其分布，来计算整个区域的数据分布状况，从而产生一个连续的表面。它主要是基于点数据生成的，以每个待计算格网点为中心， 进行环形区域的搜寻，进而来计算每个格网点的密度值。 插值的数学原理，是通过函数在有限个点处的取值状况，估算出函数在其他点处的近似值。

##### 操作示例

以建德东部七镇为研究区域，“插值”提供的工具可以帮助我们从高程采样点插值得到地表连续的栅格表面。“training.shp”是从所有高程采样点中随机抽取的训练点集，基于其插值得到栅格表面，其“CONTOUR”属性为高程值；“东部七镇行政区划.shp”为研究区域的面数据。

（1）在“Spatial Analyst工具”下拉菜单中选择“插值”，在弹出的下一级菜单中点击“地形转栅格”，出现工具对话框；

（2）在“输入要素数据”栏的下拉菜单中选择“training.shp”，字段选择“CONTOUR”，类型选择为”点高程“；

（4）为输出结果指定目录及名称，将输出的表面栅格命名为“surface_dem.tif”，输出像元大小设置为45；

（5）在顶部切换至“环境”子对话框，在“掩膜”和“输出坐标系”栏都选择“东部七镇行政区划.shp”；

（6）其余参数保留默认值，点击“运行”后得到输出（见图）即高程点插值得到的高程表面栅格。

![image-20210216145925311](image\image-2-1.png)

 

#### 7.3 表面分析

栅格数据的表面分析主要基于DEM（数字高程模型），对地形地貌进行量化及可视化。ArcGIS pro提供的“表面分析”工具主要包含了等值线工具、表面特征相关工具以及可见性分析工具。

| 工具                                        | 作用                                                         |
| ------------------------------------------- | ------------------------------------------------------------ |
| **坡向（Aspect）**                          | 获得栅格表面的坡向。求得每个像元到其相邻像元方向像元值的变化率最大的下坡方向 |
| **坡度（Slope）**                           | 判断栅格表面的各像元中的坡度（梯度或 z 值的最大变化率）      |
| **等值线（Contour）**                       | 根据栅格表面创建等值线（等值线图）的线要素类                 |
| **等值线序列（Contour List）**              | 根据栅格表面创建所选等值线值的要素类                         |
| **含障碍的等值线（Contour with Barriers）** | 根据栅格表面创建等值线；如果包含障碍要素，则允许在障碍两侧独立生成等值线 |
| **曲率（Curvature）**                       | 计算栅格表面的曲率，包括剖面曲率和平面曲率                   |
| **填挖方（Cut Fill）**                      | 计算两表面间体积的变化。通常用于执行填挖操作                 |
| **视点分析（Observer Point）**              | 识别从各栅格表面位置进行观察时可见的观察点                   |
| **视域（Viewshed）**                        | 确定对一组观察点要素可见的栅格表面位置                       |

##### 操作示例

以建德东部七镇为研究区域，“表面分析”提供的工具可以帮助我们从DEM（数字高程模型）表面得到坡度、坡向、等高线、山体阴影等表面特征。

（1）在“Spatial Analyst工具”下拉菜单中选择“表面”，在弹出的下一级菜单中点击“坡度”，出现“坡度”工具对话框；将“输入栅格”设置为“七镇DEM30.tif”，输出栅格命名为“slope.tif”，输出测量单位为“度”；其余参数保留默认值，点击“运行”得到从DEM输出的坡度特征。

![image-20210216161614590](image\image-3-1.png)



（2）工具栏中选择“坡向”工具，将“输入栅格”设置为“七镇DEM30.tif”，输出栅格命名为“aspect.tif”；其余参数保留默认值，点击“运行”得到从DEM输出的坡向特征。

![image-20210216161814907](image\image-3-2.png)

（3）工具栏中选择“等值线”工具，将“输入栅格”设置为“七镇DEM30.tif”，输出要素类命名为“contour.tif”，将等值线间距设置为200；其余参数保留默认值，点击“运行”得到从DEM输出的等高线。

![image-20210216162620643](image\image-3-3.png)

（4）工具栏中选择“山体阴影”工具，将“输入栅格”设置为“七镇DEM30.tif”，输出栅格命名为“hillshade.tif”；其余参数保留默认值，点击“运行”得到从DEM输出的山体阴影。

![image-20210216165005628](image\image-3-4.png)

#### 7.4 条件分析和重分类

为了依据一定条件或划分的范围将栅格原像元值变换至新栅格的相应像元值，需要对栅格数据进行相应的条件分析或重分类。

ArcGIS pro提供的“条件分析”工具在输入值上应用相应条件（对属性的查询等），从而对输出值进行控制。属性查询工具将所有像元在一定条件下判断为 True 或 False，将判断 True 的像元保留原始值、设置为其他值或设置为 NoData，将判断为 False 的像元设置为一组与 True 条件不同的值。

ArcGIS pro提供的“重分类”工具提供了多种可对输入像元值进行重分类或将输入像元值更改为替代值的方法。对数据进行重分类可以达到许多目的：将栅格原像元值分组赋值或替换，将像元值重分类为常用等级（例如创建用于距离累积工具的成本栅格），将特定值设置为 NoData 或将 NoData 像元设置为特定值等。

##### 操作示例

基于重分类工具和建德东部七镇的坡度数据，可以对区域内地质灾害发生敏感性进行分级（分级见下表）。

| 分级         | 一般敏感 | 较敏感 | 中度敏感 | 高度敏感 | 极敏感 |
| ------------ | -------- | ------ | -------- | -------- | ------ |
| 坡度（℃）    | 0-3      | 3-10   | 10-20    | 20-30    | \>30   |
| 地质灾害指数 | 1        | 3      | 5        | 7        | 9      |

（1）在“Spatial Analyst工具”下拉菜单中选择“重分类”，在弹出的下一级菜单中点击“重分类”，出现工具对话框；

![image-20210216195419834](image\image-4-1.png)

（2）将“输入栅格”设置为“slope.tif”，重分类字段设为“VALUE”，输出栅格命名为“classify_slope.tif”；

（3）点击重分类表格下方的“分类”，在弹出的“相等间隔分类”窗口中设置类数目为5，“启动”和“结束”分别设置为各级坡度的最小值与最小值，“新建”设置为该类取值范围对应的地质灾害指数；

（4）其余参数保留默认值，点击“运行”得到从DEM输出的重分类结果。

![image-20210216200657259](image\image-4-2.png)

#### 7.5 提取分析

提取分析工具集主要提供从栅格中提取像元子集的各种方法，依据像元的属性或其空间位置。ArcGIS pro提供的相应工具包括以下几种：

1. 按照属性值提取像元（按属性提取）可通过一个 where 子句来完成。例如，从高程栅格中提取高程高于 100 米的像元。
2. 按照像元空间位置的几何提取像元时，要求像元组必须位于指定几何形状的内部或外部（按圆形区域提取、按多边形提取、按矩形提取）。
3. 按照指定位置提取像元时，需要根据像元的 x,y 点位置来识别像元的位置（按点提取），或者通过使用掩膜栅格数据来识别像元的位置（按掩膜提取）。

通过提取分析，也可以将栅格数据在特定位置的像元值作为点要素类中的属性或表。ArcGIS pro提供的相应工具包括“值提取至点”、“多值提取至点”以及“采样”。

##### 操作示例

基于ArcGIS pro的提取分析工具，可以将建德东部七镇数字高程模型的栅格表面值提取至测试点，从而可以进一步比较提取得到的表面高程值与测试点的实际高程值，评价空间插值的结果。测试点“test.shp”是从所有高程采样点中除去训练样本得到的测试点集；使用“值提取至点”工具。

（1）在“Spatial Analyst工具”下拉菜单中选择“提取”，在弹出的下一级菜单中点击“值提取至点”，出现工具对话框；

（2）在“输入点要素”栏的下拉菜单中选择“test.shp”，输入栅格设置为“七镇DEM30.tif”；

（3）其余参数保留默认值，将输出点要素命名为“test_value.shp”，点击“运行”后得到提取高程值的测试点；

（4）查看输出点要素的属性表，“RASTERVALU”字段即为提取七镇DEM得到的高程值。

![image-20210217002214366](image\image-5-1.png)

![image-20210216220828262](image\image-5-2.png)

#### 7.6 叠加分析

叠加分析主要应用于适宜性建模。ArcGIS pro提供的叠加分析工具可以将权重应用到多个输入图层中，将它们合并成一个输出，同时遵守分布与形状规范，并标识该结果范围内的首选位置。

使用加权叠加、加权总和工具，利用最常规的方法对“叠加”分析中的多个输入栅格进行重新分类和加权；模糊叠加、模糊隶属度工具将模糊逻辑作为一种机制来解决属性及空间数据集中几何的固有不精确问题；查找区域工具用于标识组合表面中满足特定需求的最佳位置或区域。

| 工具       | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| 模糊隶属度 | 根据指定的模糊化算法，将输入栅格转换为 0 到 1 数值范围以指示其对某一集合的隶属度。 |
| 模糊叠加   | 基于所选叠加类型组合模糊分类栅格数据。                       |
| 查找区域   | 通过满足指定评估标准且满足确定形状、大小、数量和区域间距离约束的输入效用值（适宜性）栅格来标识最佳区域或连续像元组。 |
| 加权叠加   | 使用常用测量比例叠加多个栅格数据，并根据各栅格数据的重要性分配权重。 |
| 加权总和   | 通过将栅格各自乘以指定的权重并合计在一起来叠加多个栅格。     |

##### 操作示例

ArcGIS pro提供的“叠加分析”工具可以帮助我们构建多因子影响下的评价模型。以建德东部七镇作为研究区域，可以选取若干环境影响因子，构建相应的水土流失敏感性评价模型、生态系统服务功能评价模型等。本例将构建一个受土壤因子、坡度因子影响的简单模型，用以评价区域内水土流失的敏感性。“erode.tif”表示了区域内不同土壤类型的易受侵蚀程度，像元值赋值为1~9（共四级，1为最不敏感，9为最敏感）；“classify_slope.tif”为前述重分类小节中得到的坡度因子，表示坡度影响下的地质灾害易发程度，赋值为1~9（共五级，1为最不易发，9为最易发）；使用“加权总和”工具，将土壤因子的权重分配为0.3，坡度因子的权重分配为0.7。

![image-20210216235442304](image\image-6-1.png)

（1）在“Spatial Analyst工具”下拉菜单中选择“叠加”，在弹出的下一级菜单中点击“加权总和”，出现工具对话框；

（2）在输入栅格中分别添加“erode.tif”和“classify_slope.tif”，将权重分别设置为0.3和0.7；

（3）将输出栅格命名为“水土流失易发性.tif”，其余参数保留默认值，点击“运行”得到叠加结果。

![image-20210217000505841](image\image-6-2.png)

#### 7.7 密度分析

密度分析包括点密度分析、核密度分析、线密度分析，主要通过密度表面显示点、折线等要素的聚集情形。例如，可以制作人口密度图反映城市人口聚集情况，或根据污染源数据来分析城市污染的分布情况。密度制图从本质上讲，是一个通过离散采样点进行表面内插的过程，从而计算出每个输出栅格像元周围邻域内输入要素的密度。

##### 操作示例

以建德东部七镇作为研究区域，ArcGIS pro提供的密度分析工具可以帮助我们研究区域内一些地点的聚集情形。本例通过核密度分析工具，探究七镇风景点在空间上的聚集特征。

（1）在“Spatial Analyst工具”下拉菜单中选择“密度”，在弹出的下一级菜单中点击“核密度分析”，出现工具对话框；

（2）在“输入点或折线要素”栏的下拉菜单中选择“七镇风景点.shp”，“填充字段”选择为NONE，将输出像元大小设置为45；

（3）在顶部切换至“环境”子对话框，在“输出坐标系”和“处理范围”栏都选择与“东部七镇行政区划.shp”相同；

（4）在顶部切换回到“参数”子对话框，将输出栅格命名为“density.tif”，其余参数保留默认值，点击“运行”得到密度分析结果。

![image-20210217104830279](image\image-7-1.png)

![image-20210217104737525](image\image-7-2.png)

#### 7.8 栅格计算器

“地图代数”是通过使用代数语言创建表达式以执行空间分析的一种方法，而ArcGIS pro提供的栅格计算器通过一定语法（Python语法）来构建和执行单个地图代数表达式。栅格计算器工具的具体规则如下：

1. 使用栅格列表选择要用于表达式中的数据集和变量，工具列表提供一组常用的条件分析工具和数学工具。

2. 可在引号 ("") 中输入数据的完整路径或指定的当前工作空间环境设置中存在的数据，数字和标量可直接输入。

3. 格计算器工具对话框中的运算符包括：`+ 加` `- 减` `* 乘` `/ 除` `== 等于` `> 大于` `< 小于` `<= 小于等于` `>= 大于等于` `!= 不等于` `<= 小于等于` `& 布尔与` `| 布尔或` `^ 布尔亦或` `~ 布尔非`

4. 表达式使用标准 Python 语法，可以在地图代数表达式中合并多个地理处理工具和操作（区分大小写）。

5. 栅格计算器工具可以应用于 ModelBuilder 中，且遵循以下语法：图层名称将括在双引号 ("") 中，长整型、双精度型或布尔型变量将括在百分号 (%%) 中，表示数据集名称或字符串的变量应括在引号和百分号 ("%%") 中。

##### 操作示例

波段运算实质是对每个像素点对应的像素值进行数学运算，而通过ArcGIS pro提供的栅格计算器工具可以对遥感图像进行多种波段运算。本例基于建德市的Landsat遥感影像“LandsatTM.tif”（共选取了Red、Green、Blue三个波段），对红光波段、绿光波段、蓝光波段三个波段求和并输出结果图像。

（1）将“LandsatTM.tif”的三个波段单独添加至地图，分别为“LandsatTM.tif_Band_1” “LandsatTM.tif_Band_2” “LandsatTM.tif_Band_3”；

![image-20210217135048659](image\image-8-1.png)

（2）在“Spatial Analyst工具”下拉菜单中选择“地图代数”，在弹出的下一级菜单中点击“栅格计算器”，出现工具对话框；

（3）依次双击“栅格”列表中的“LandsatTM.tif_Band_1”等栅格和右侧的运算符，得到地图代数表达式` "LandsatTM.tif_Band_1" + "LandsatTM.tif_Band_2" + "LandsatTM.tif_Band_3"`；

（4）将输出栅格命名为“sum.tif”，其余参数保留默认值，点击“运行”得到计算结果。

![image-20210217144156440](image\image-8-2.png)

#### 7.9 统计分析  

根据栅格数据各像元统计分析的范围大小不同，可以分为局部分析、邻域分析、区域分析，每一个类别都对应ArcGIS Pro的Spatial Analyst工具箱内的一组工具。

##### 7.9.1 局部分析

局部分析工具集主要用于多层面栅格数据的叠合分析，对栅格数据以像元为单位进行像元统计分析。在分析过程中，输出的栅格结果中各位置像元值仅受输入的各栅格数据的相应位置的像元影响，因此具有统计计算的局部性特征。例如，对同一地区的多时相数据进行局部分析（同一地区不同年份的人口数据分析等）

| 工具               | 说明                                                         |
| ------------------ | ------------------------------------------------------------ |
| 像元统计数据       | 根据多个栅格数据计算每个像元的统计数据。可用的统计数据有：众数、最大值、均值、中位数、最小值、少数、范围、标准差、总和及变异度。 |
| 合并               | 合并多个栅格，从而为输入值的各种唯一组合生成唯一输出值。     |
| 大于/小于/等于频数 | 基于单个像元计算一组栅格数据值大于/小于/等于另一个栅格数据值的次数。 |
| 最高/最低位置      | 逐个像元来确定一组栅格中具有最大值/最小值的栅格的位置。      |
| 频数取值           | 逐个像元地确定参数列表中具有特定频数级别的值。特定的频数级别（每个值的出现次数）由第一个参数指定。 |
| 等级               | 输入栅格集中的值将被逐个像元地进行等级排定，返回哪个等级将由等级输入栅格的值来确定。 |

##### 7.9.2 邻域分析

邻域分析是以输入数据的像元值为中心，向周围扩展一定的范围，基于扩展范围内的栅格数据进行函数运算，并将结果输出到相应的单元位置的过程。邻域分析的邻域类型可为移动或搜索半径。其中，移动邻域可以是重叠的，也可以是非重叠的。

ArcGIS Pro提供的常用邻域分析工具如下：

* 焦点统计工具：采用重叠邻域为每个输入像元周围指定邻域内的像元计算指定的统计数据。例如，可以在某个输入栅格中每个像元周围 3 x 3 邻域内的平均值或最大值。
* 滤波器工具：一种特定类型的焦点运算，使用高通滤波器或低通滤波器来锐化或平滑数据。
* 块统计工具：将输入分割放入非重叠块中，然后计算每个块中值的统计数据；在输出中将值分配给每个块中的所有像元。

##### 7.9.3 区域分析

区域分析是对输入栅格数据的所有像元进行分析，并输出计算结果的过程。其中，区域可以定义为具有特定值的单个区域，由具有相同值的多个断开元素或区域组成。ArcGIS Pro提供的区域分析工具主要具有以下用途：①对输入区域的某些几何或形状属性进行量化，并且不需要其他输入；②使用区域输入来定义将用于计算其他参数的位置，如统计数据、面积或值频数等；③使用沿区域边界找到的最小值填充指定区域。

| 工具                   | 说明                                                         |
| ---------------------- | ------------------------------------------------------------ |
| 区域制表               | 计算两个数据集之间交叉制表的区域并输出表。                   |
| 区域填充               | 使用权重栅格数据沿区域边界的最小像元值填充区域。             |
| 分区几何统计           | 为数据集中的各个区域计算指定的几何测量值（面积、周长、厚度或者椭圆的特征值）。 |
| 以表格显示分区几何统计 | 为数据集中的各个区域计算几何测量值（面积、周长、厚度和椭圆的特征值）并以表的形式来显示结果。 |
| 区域直方图             | 创建显示各唯一区域值输入中的像元值频数分布的表和直方图。     |
| 分区统计               | 计算位于另一数据集区域内的栅格值的统计信息。                 |
| 以表格显示分区统计     | 汇总另一个数据集区域内的栅格数据值并以表的形式显示结果。     |

##### 操作示例

以建德东部七镇作为研究区域，本例将基于区域的数字高程模型数据（DEM）示范如何统计各镇的平均高程。主要使用ArcGIS Pro在区域分析工具集中的“分区统计”工具。

（1）在“Spatial Analyst工具”下拉菜单中选择“区域分析”，在弹出的下一级菜单中点击“分区统计”，出现工具对话框；

（2）在“区域字段”栏的下拉菜单中选择“乡镇名称”，“输入赋值栅格”选择为“七镇DEM30.tif”，统计类型选择“平均值”；

（3）在顶部切换至“环境”子对话框，在“输出坐标系”和“处理范围”栏都选择与“东部七镇行政区划.shp”相同；

（4）将输出栅格命名为“zonal_dem.tif”，其余参数保留默认值，点击“运行”得到分区统计结果。

![image-20210217154210724](image\image-9-1.png)

#### 7.10 练习和实例

##### 综合利用实例：水土流失敏感性评价

